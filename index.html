<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>8æ¨“ç—…æˆ¿é ç­è¡¨ - é›²ç«¯åŒæ­¥ç‰ˆ</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --off-color: #ff5252; --v-color: #ffa726; --travel-color: #2196f3;
            --study-color: #8bc34a; --meet-color: #9c27b0;
            --weekend-bg: #ffe3e3; --header-bg: #2c3e50; 
            --locked-day-bg: #ffeded;
        }
        body { font-family: "Microsoft JhengHei", sans-serif; margin: 0; padding: 15px; background-color: #f4f7f9; }
        .admin-box { background: #fff; padding: 15px; border-radius: 10px; border: 2px solid #e74c3c; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .admin-toggle { background: #e74c3c; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .admin-tools { margin-top: 10px; padding: 15px; background: #fff5f5; border-radius: 8px; display: none; border: 1px dashed #e74c3c; }
        .header-area { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .btn-group button { padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; border: none; color: white; margin-left: 10px; }
        .save-btn { background-color: #2c3e50; }
        .export-btn { background-color: #27ae60; }
        .swap-btn { background-color: #f39c12; }
        .table-wrapper { max-height: 60vh; overflow: auto; background: white; border: 1px solid #ccc; zoom: 0.85; }
        table { border-collapse: separate; border-spacing: 0; width: 100%; table-layout: fixed; }
        th, td { border: 1px solid #eee; padding: 4px 1px; text-align: center; min-width: 42px; font-size: 14px; }
        thead th { position: sticky; top: 0; background: #f8f9fa; z-index: 10; height: 65px; border-bottom: 2px solid #ddd; }
        .sticky-col { position: sticky; left: 0; background: #eee !important; font-weight: bold; z-index: 11; border-right: 3px solid #bbb; min-width: 140px; }
        .is-weekend { background-color: var(--weekend-bg) !important; color: #d32f2f; }
        .locked-column { background-color: var(--locked-day-bg) !important; }
        select { width: 95%; padding: 6px 0; border-radius: 4px; border: 1px solid #ddd; font-weight: bold; font-size: 13px; cursor: pointer; appearance: none; text-align-last: center; }
        select.val-OFF { background-color: var(--off-color); color: white; }
        select.val-V { background-color: var(--v-color); color: white; }
        select.val-å“¡æ—… { background-color: var(--travel-color); color: white; }
        select.val-ä¸Šèª² { background-color: var(--study-color); color: white; }
        select.val-é–‹æœƒ { background-color: var(--meet-color); color: white; }
        #changeLog { max-height: 120px; overflow-y: auto; font-size: 13px; padding: 10px; background: #fff; border: 1px solid #ddd; border-radius: 8px; }
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: none; justify-content: center; align-items: center; z-index: 999; font-weight: bold; color: #2c3e50; }
    </style>
</head>
<body>

<div id="loadingOverlay">â˜ï¸ é›²ç«¯è³‡æ–™åŒæ­¥ä¸­ï¼Œè«‹ç¨å€™...</div>

<div class="admin-box">
    <button class="admin-toggle" onclick="toggleAdmin()">âš™ï¸ ç®¡ç†è€…æ¨¡å¼</button>
    <span id="modeLabel" style="font-weight:bold; margin-left:10px; color:#e74c3c;">ã€ç³»çµ±è¼‰å…¥ä¸­ã€‘</span>
    <div id="openSettings" class="admin-tools">
        <div style="display: flex; gap: 20px;">
            <div style="flex: 1.2;">
                <strong>1. é–‹æ”¾é¡¯ç¤ºé€±æœŸï¼š</strong>
                <div id="checkboxContainer" style="margin-top:5px; max-height: 120px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; background: white;"></div>
                <button onclick="saveSystemSettings()">ğŸ’¾ å„²å­˜é€±æœŸè¨­å®š</button>
            </div>
            <div style="flex: 1; border-left: 1px solid #e74c3c; padding-left: 20px;">
                <strong>2. å¡«å ±æ™‚é–“é–‹é—œï¼š</strong><br>
                é–‹å§‹ï¼š<input type="datetime-local" id="openStartTime"><br>
                çµæŸï¼š<input type="datetime-local" id="openEndTime"><br>
                <button onclick="saveTimeSettings()" style="margin-top:5px; background:#e74c3c; color:white;">ğŸ’¾ å„²å­˜æ™‚é–“</button>
            </div>
            <div style="flex: 1; border-left: 1px solid #e74c3c; padding-left: 20px;">
                <strong>3. ç®¡ç†å·¥å…·ï¼š</strong><br>
                <button onclick="randomDistributeWeekends()" style="margin-top:5px; background:#666; color:white; width:100%;">ğŸ² éš¨æ©Ÿå¹³å‡åˆ†é…å‡æ—¥</button>
            </div>
        </div>
    </div>
    <div style="margin-top: 10px;">
        ç­è¡¨é¸æ“‡ï¼š<select id="periodPicker" onchange="changePeriod(this.value)"></select>
        <button onclick="toggleZoom()" style="margin-left:20px;">ğŸ” ç¸®æ”¾åˆ‡æ›</button>
    </div>
</div>

<div class="header-area">
    <div><h2 style="margin:0;">ğŸ¥ 8æ¨“ç—…æˆ¿é ç­è¡¨ <span id="statusNotice" style="font-size:14px; font-weight:normal;"></span></h2></div>
    <div class="btn-group">
        <button class="swap-btn" onclick="swapFullWeekend()">ğŸ” å‡æ—¥ä»£è™Ÿäº’æ›</button>
        <button class="save-btn" onclick="saveToCloud()">ğŸ’¾ å„²å­˜</button>
        <button class="export-btn" onclick="exportToExcel()">ğŸ“¥ åŒ¯å‡º Excel</button>
    </div>
</div>

<div class="table-wrapper" id="zoomWrapper">
    <table id="mainTable">
        <thead><tr id="dateHeader"><th class="sticky-col">å“¡å·¥-å§“å</th></tr></thead>
        <tbody id="tableBody"></tbody>
        <tfoot><tr style="background:#eee; font-weight:bold;" id="footerStats"><td class="sticky-col">ç•¶æ—¥é å‡ç¸½æ•¸</td></tr></tfoot>
    </table>
</div>

<div style="margin-top: 15px;"><h4 style="margin:0 0 5px 0; color:#2980b9;">ğŸ”„ å‡æ—¥ç•°å‹•è¿½è¹¤ (åƒ…ç´€éŒ„å…­æ—¥)</h4><div id="changeLog">å°šæœªæœ‰ç´€éŒ„</div></div>

<script>
    // å·²è‡ªå‹•å¡«å…¥æ‚¨çš„ GAS ç¶²å€
    const GAS_URL = "https://script.google.com/macros/s/AKfycbz0Yg42Tr8X2cNrMP3DXyhBUrYjE7WCI4qWqCCUqA5b5ard1LmFqRGxaQ-ThuxI65TU/exec";
    
    const ADMIN_PW = "810713"; 
    const staffList = ["3632-æ—å’¨ç’‡", "M820-æç­±è–‡", "M599-è³´ç‰ç«", "M944-è¬å®¶æ¦†", "M956-æ—è©©æ¶µ", "M976-æ—èŠå¦˜", "N007-é™³éƒå©·", "E578-ç‹æ·‘å¨Ÿ", "M798-å³ä¾è“", "N513-è‘‰æ‡¿å¬‹", "N530-é¾å®¶æ–‡", "N639-æ›¾æ„æ™´", "N645-è³´å¦™è²", "N881-æ›¾è‰é›¯", "N994-æ—æ˜±å‡", "M028-è‘£ç¥æ…ˆ", "M226-å¾éƒé›¯", "M296-å³ä½³ç²", "M343-é»ƒèºç¶º", "M510-é™³å»ºå„’", "M536-å¼µç›ˆç¶º", "M637-åŠ‰ä½³è±«", "M697-å¼µæ–‡ç”„", "N054-é™³æ€å®‡", "M701-è”¡æ˜€çŠ", "M775-åŠ‰èŠ·å‡Œ"];
    let isAdmin = false, currentStartDate, allPeriods = [], openPeriods = [], lockedDays = [], timeConfig = null;

    async function init() {
        let tempDate = new Date(2026, 2, 9); 
        for (let i = 0; i < 52; i++) {
            let start = new Date(tempDate), end = new Date(tempDate);
            end.setDate(start.getDate() + 27);
            allPeriods.push({ timestamp: start.getTime(), label: `${start.getMonth()+1}/${start.getDate()} - ${end.getMonth()+1}/${end.getDate()}` });
            tempDate.setDate(tempDate.getDate() + 28);
        }
        await loadGlobalConfig();
        renderAdminCheckboxes();
        renderPeriodPicker();
        setInterval(checkAccess, 5000); 
    }

    async function loadGlobalConfig() {
        showLoading(true);
        try {
            const resp = await fetch(`${GAS_URL}?sheetName=Config&key=global`);
            const text = await resp.text();
            if (text) {
                const config = JSON.parse(text);
                openPeriods = config.openPeriods || [allPeriods[0].timestamp];
                timeConfig = config.timeConfig || null;
                if(timeConfig) {
                    document.getElementById('openStartTime').value = timeConfig.start || '';
                    document.getElementById('openEndTime').value = timeConfig.end || '';
                }
            }
        } catch(e) { console.error("é›²ç«¯è®€å–å¤±æ•—"); }
        showLoading(false);
    }

    async function saveToCloud() {
        if (!currentStartDate) return;
        showLoading(true);
        const grid = Array.from(document.querySelectorAll("#tableBody tr")).map(row => Array.from(row.querySelectorAll("select")).map(s => s.value));
        try {
            const response = await fetch(GAS_URL, {
                method: "POST",
                mode: "no-cors",
                body: JSON.stringify({ sheetName: "Data", key: currentStartDate.getTime(), value: JSON.stringify(grid) })
            });
            alert("âœ… é›²ç«¯å„²å­˜æˆåŠŸï¼");
        } catch(e) { alert("âŒ å„²å­˜å¤±æ•—"); }
        showLoading(false);
    }

    async function loadFromCloud() {
        if (!currentStartDate) return;
        showLoading(true);
        try {
            const resp = await fetch(`${GAS_URL}?sheetName=Data&key=${currentStartDate.getTime()}`);
            const text = await resp.text();
            const rows = document.querySelectorAll("#tableBody tr");
            rows.forEach(row => row.querySelectorAll("select").forEach(s => { s.value=""; s.className=""; }));
            if (text) {
                const grid = JSON.parse(text);
                rows.forEach((row, rIdx) => {
                    row.querySelectorAll("select").forEach((s, cIdx) => {
                        if(grid[rIdx] && grid[rIdx][cIdx]) { s.value = grid[rIdx][cIdx]; s.className = `val-${s.value}`; }
                    });
                });
            }
            const lockResp = await fetch(`${GAS_URL}?sheetName=Locks&key=${currentStartDate.getTime()}`);
            const lockText = await lockResp.text();
            lockedDays = lockText ? JSON.parse(lockText) : [];
            renderTable(false); 
        } catch(e) { console.error("è®€å–å¤±æ•—"); }
        showLoading(false);
        refreshUI();
    }

    function renderTable(clearData = true) {
        if(!currentStartDate) return;
        const header = document.getElementById('dateHeader'), tbody = document.getElementById('tableBody'), footer = document.getElementById('footerStats');
        header.innerHTML = '<th class="sticky-col">å“¡å·¥-å§“å</th>';
        if(clearData) tbody.innerHTML = '';
        footer.innerHTML = '<td class="sticky-col">ç•¶æ—¥é å‡ç¸½æ•¸</td>';
        for (let i = 0; i < 28; i++) {
            let curr = new Date(currentStartDate.getTime()); curr.setDate(currentStartDate.getDate() + i);
            let th = document.createElement('th');
            if (curr.getDay()===0 || curr.getDay()===6) th.className = 'is-weekend';
            if (lockedDays.includes(i)) th.classList.add('locked-column');
            let lockIcon = isAdmin ? `<span style="cursor:pointer" onclick="toggleDayLock(${i})">${lockedDays.includes(i) ? 'ğŸ”’' : 'ğŸ”“'}</span><br>` : (lockedDays.includes(i) ? 'ğŸ”’<br>' : '');
            th.innerHTML = `${lockIcon}${curr.getDate()}<br><span style="font-size:11px">${["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"][curr.getDay()]}</span>`;
            header.appendChild(th);
            let td = document.createElement('td'); td.id = `total-${i}`; if(lockedDays.includes(i)) td.classList.add('locked-column'); footer.appendChild(td);
        }
        if(clearData) {
            staffList.forEach((staff) => {
                let tr = document.createElement('tr');
                tr.innerHTML = `<td class="sticky-col">${staff}</td>`;
                for (let i = 0; i < 28; i++) {
                    let td = document.createElement('td');
                    let curr = new Date(currentStartDate.getTime()); curr.setDate(currentStartDate.getDate() + i);
                    const isW = (curr.getDay()===0 || curr.getDay()===6);
                    if (isW) td.className = 'is-weekend';
                    td.innerHTML = `<select onchange="handleCellChange(this, '${staff.split('-')[1]}', ${curr.getDate()}, ${isW})">
                        <option value="">--</option><option value="OFF">OFF</option><option value="V">V</option><option value="å“¡æ—…">æ—…</option><option value="ä¸Šèª²">èª²</option><option value="é–‹æœƒ">æœƒ</option>
                    </select>`;
                    tr.appendChild(td);
                }
                tbody.appendChild(tr);
            });
            loadFromCloud();
        } else {
            document.querySelectorAll("#tableBody tr").forEach(row => {
                row.querySelectorAll("td:not(.sticky-col)").forEach((td, i) => {
                    if (lockedDays.includes(i)) td.classList.add('locked-column'); else td.classList.remove('locked-column');
                });
            });
        }
    }

    async function toggleDayLock(idx) {
        const pos = lockedDays.indexOf(idx);
        if (pos === -1) lockedDays.push(idx); else lockedDays.splice(pos, 1);
        await fetch(GAS_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ sheetName: "Locks", key: currentStartDate.getTime(), value: JSON.stringify(lockedDays) }) });
        renderTable(false);
    }

    async function saveSystemSettings() { openPeriods = Array.from(document.querySelectorAll('#checkboxContainer input:checked')).map(cb => parseInt(cb.value)); await saveGlobal(); alert("é€±æœŸæ›´æ–°æˆåŠŸ"); renderPeriodPicker(); }
    async function saveTimeSettings() { timeConfig = { start: document.getElementById('openStartTime').value, end: document.getElementById('openEndTime').value }; await saveGlobal(); alert("æ™‚é–“æ›´æ–°æˆåŠŸ"); checkAccess(); }
    async function saveGlobal() { await fetch(GAS_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ sheetName: "Config", key: "global", value: JSON.stringify({ openPeriods, timeConfig }) }) }); }

    function showLoading(show) { document.getElementById('loadingOverlay').style.display = show ? "flex" : "none"; }
    function checkAccess() {
        if (isAdmin) { updateUI(true, "ç®¡ç†è€…æ¨¡å¼"); return; }
        let isAllowed = false, text = "ç³»çµ±é–å®šä¸­";
        if (timeConfig && timeConfig.start && timeConfig.end) {
            const now = new Date(), start = new Date(timeConfig.start), end = new Date(timeConfig.end);
            isAllowed = now >= start && now <= end;
            text = isAllowed ? `é–‹æ”¾è‡³ ${timeConfig.end.replace('T',' ')}` : "ç³»çµ±é–å®šä¸­";
        }
        updateUI(isAllowed, text);
    }
    function updateUI(isAllowed, text) {
        document.querySelectorAll("#tableBody select").forEach((s, idx) => s.disabled = !isAllowed || (lockedDays.includes(idx % 28) && !isAdmin));
        const sn = document.getElementById('statusNotice'); if(sn) { sn.innerText = `(${text})`; sn.style.color = isAllowed ? "#27ae60" : "#e74c3c"; }
    }
    function handleCellChange(el, name, date, isW) { el.className = el.value ? `val-${el.value}` : ''; if (isW) addLog(`ğŸ“ ${name} æ”¹ ${date}æ—¥(å‡æ—¥) ç‚º: ${el.value || "ä¸Šç­"}`); refreshUI(); }
    function addLog(msg) { const logDiv = document.getElementById('changeLog'); if (logDiv.innerHTML === "å°šæœªæœ‰ç´€éŒ„") logDiv.innerHTML = ""; logDiv.innerHTML = `<div>[${new Date().toLocaleTimeString()}] ${msg}</div>` + logDiv.innerHTML; }
    function refreshUI() { for (let i = 0; i < 28; i++) { let count = 0; document.querySelectorAll(`#tableBody tr td:nth-child(${i + 2}) select`).forEach(s => { if (s.value !== "") count++; }); if(document.getElementById(`total-${i}`)) document.getElementById(`total-${i}`).innerText = count; } }
    function toggleAdmin() { if (!isAdmin && prompt("ç®¡ç†è€…å¯†ç¢¼ï¼š") !== ADMIN_PW) return alert("å¯†ç¢¼éŒ¯èª¤"); isAdmin = !isAdmin; document.getElementById('openSettings').style.display = isAdmin ? "block" : "none"; renderPeriodPicker(); checkAccess(); }
    function changePeriod(ts) { currentStartDate = new Date(parseInt(ts)); renderTable(true); }
    function renderAdminCheckboxes() { document.getElementById('checkboxContainer').innerHTML = allPeriods.map(p => `<div style="display:inline-block; width:180px;"><input type="checkbox" value="${p.timestamp}" ${openPeriods.includes(p.timestamp)?'checked':''}> ${p.label}</div>`).join(''); }
    function renderPeriodPicker() { const picker = document.getElementById('periodPicker'); const available = allPeriods.filter(p => isAdmin || openPeriods.includes(p.timestamp)); picker.innerHTML = available.map(p => `<option value="${p.timestamp}">${p.label}</option>`).join(''); if(available.length > 0) changePeriod(picker.value); }
    function toggleZoom() { const w = document.getElementById('zoomWrapper'); w.style.zoom = (w.style.zoom === "1") ? "0.85" : "1"; }
    function swapFullWeekend() {
        const myCode = prompt("æ‚¨çš„ä»£è™Ÿ:"), targetCode = prompt("å°æ–¹ä»£è™Ÿ:");
        if (!myCode || !targetCode) return;
        const mi = staffList.findIndex(s => s.startsWith(myCode.toUpperCase())), ti = staffList.findIndex(s => s.startsWith(targetCode.toUpperCase()));
        if (mi === -1 || ti === -1) return alert("æ‰¾ä¸åˆ°ä»£è™Ÿ");
        const rows = document.querySelectorAll("#tableBody tr");
        let myD = [], tgD = [];
        for (let i = 0; i < 28; i++) {
            let d = new Date(currentStartDate.getTime()); d.setDate(currentStartDate.getDate() + i);
            if (d.getDay() === 0 || d.getDay() === 6) {
                let ms = rows[mi].querySelectorAll("select")[i], ts = rows[ti].querySelectorAll("select")[i];
                if(ms.value==="OFF") myD.push(d.getDate()); if(ts.value==="OFF") tgD.push(d.getDate());
                let tmp = ms.value; ms.value = ts.value; ts.value = tmp;
                ms.className = ms.value ? `val-${ms.value}` : ''; ts.className = ts.value ? `val-${ts.value}` : '';
            }
        }
        refreshUI();
        addLog(`ğŸ” å‡æ—¥äº’æ›ï¼š${staffList[mi].split('-')[1]}(${myD.join('.')}) â†”ï¸ ${staffList[ti].split('-')[1]}(${tgD.join('.')})`);
        alert("äº’æ›å®Œæˆï¼");
    }
    function randomDistributeWeekends() {
        if (!isAdmin) return;
        if (!confirm("ç¢ºå®šåŸ·è¡Œéš¨æ©Ÿåˆ†é…ï¼Ÿ")) return;
        const rows = document.querySelectorAll("#tableBody tr");
        const weekends = [[5,6], [12,13], [19,20], [26,27]]; 
        rows.forEach(row => row.querySelectorAll("select").forEach(s => { if(weekends.flat().includes(Array.from(row.querySelectorAll("select")).indexOf(s))) {s.value=""; s.className="";} }));
        let sIndices = Array.from({length: rows.length}, (_, i) => i);
        for (let i = sIndices.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [sIndices[i], sIndices[j]] = [sIndices[j], sIndices[i]]; }
        let dist = [7, 7, 6, 6];
        for (let i = 3; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [dist[i], dist[j]] = [dist[j], dist[i]]; }
        let ptr = 0;
        dist.forEach((count, wIdx) => {
            const [sat, sun] = weekends[wIdx];
            for (let i = 0; i < count; i++) { const selects = rows[sIndices[ptr]].querySelectorAll("select"); [sat, sun].forEach(idx => { selects[idx].value = "OFF"; selects[idx].className = "val-OFF"; }); ptr++; }
        });
        refreshUI();
        addLog(`ğŸ² éš¨æ©Ÿåˆ†é…å®Œæˆ (é…æ¯”: ${dist.join('-')})`); alert("åˆ†é…å®Œæˆï¼");
    }
    function exportToExcel() {
        const data = [["å“¡å·¥-å§“å", ...Array.from({length:28}, (_,i)=>{ let d = new Date(currentStartDate.getTime()); d.setDate(currentStartDate.getDate()+i); return `${d.getMonth()+1}/${d.getDate()}(${["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"][d.getDay()]})`; })]];
        document.querySelectorAll("#tableBody tr").forEach(row => { data.push([row.querySelector("td").innerText, ...Array.from(row.querySelectorAll("select")).map(s => s.value)]); });
        const ws = XLSX.utils.aoa_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "é æ’ç­è¡¨"); XLSX.writeFile(wb, `8Fé ç­è¡¨_${currentStartDate.toLocaleDateString()}.xlsx`);
    }
    window.onload = init;
</script>
</body>
</html>